<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Community | HuggingHeart</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #2f855a; --soft: #eaf7f0; --gray: #6b7280; --border: #eee; }
        body { margin: 0; font-family: 'Poppins', sans-serif; background: #fff; color: #333; }
        
        /* Navbar */
        .navbar { display: flex; justify-content: space-between; align-items: center; padding: 15px 5%; border-bottom: 1px solid var(--border); position: sticky; top: 0; background: white; z-index: 1000; }
        .logo { font-family: 'Playfair Display', serif; font-size: 22px; color: var(--primary); font-weight: bold; text-decoration: none; }
        .nav-links a { text-decoration: none; color: var(--gray); margin-left: 20px; font-size: 14px; }

        /* Layout */
        .main-wrapper { display: flex; max-width: 1300px; margin: 30px auto; padding: 0 20px; gap: 30px; }
        .sidebar { width: 240px; flex-shrink: 0; }
        .filter-card { background: #fbfbfb; padding: 20px; border-radius: 15px; border: 1px solid var(--border); position: sticky; top: 90px; }
        .filter-group { margin-bottom: 15px; }
        .filter-group label { display: block; font-size: 11px; font-weight: 600; color: var(--primary); text-transform: uppercase; margin-bottom: 5px; }
        .filter-group select, .filter-group input { width: 100%; padding: 8px; border-radius: 8px; border: 1px solid #ddd; outline: none; }

        /* Grid */
        .grid { flex: 1; display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; }
        .card { background: white; border-radius: 12px; border: 1px solid var(--border); overflow: hidden; cursor: pointer; transition: 0.2s; text-align: center; }
        .card:hover { transform: translateY(-3px); border-color: var(--primary); box-shadow: 0 10px 20px rgba(0,0,0,0.05); }
        .card img { width: 100%; height: 180px; object-fit: cover; background: #eee; }
        .card h3 { font-family: 'Playfair Display', serif; font-size: 15px; margin: 10px 0 2px; }
        .card p { font-size: 11px; color: var(--gray); margin-bottom: 10px; }

        /* Overlay */
        #profileOverlay { display: none; position: fixed; inset: 0; background: white; z-index: 2000; overflow-y: auto; padding: 40px 20px; }
        .profile-container { max-width: 800px; margin: 0 auto; display: flex; gap: 40px; }
        .profile-left img { width: 300px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .btn-chat { background: var(--primary); color: white; border: none; padding: 12px 25px; border-radius: 25px; cursor: pointer; font-weight: 600; margin-top: 15px; }

        /* Chat Bot */
        #chatBox { display: none; position: fixed; bottom: 20px; right: 20px; width: 320px; height: 450px; background: white; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); z-index: 3000; flex-direction: column; border: 1px solid var(--primary); overflow: hidden; }
        .chat-header { background: var(--primary); color: white; padding: 12px; font-size: 14px; font-weight: 600; display: flex; justify-content: space-between; }
        .chat-msgs { flex: 1; padding: 15px; overflow-y: auto; background: #f9f9f9; display: flex; flex-direction: column; gap: 8px; }
        .msg { padding: 8px 12px; border-radius: 12px; font-size: 12px; max-width: 85%; }
        .bot { background: var(--soft); align-self: flex-start; }
        .user { background: var(--primary); color: white; align-self: flex-end; }
        .sugg-box { padding: 5px; border-top: 1px solid var(--border); display: none; background: #fff; max-height: 80px; overflow-y: auto; }
        .sugg-item { padding: 5px 10px; font-size: 10px; cursor: pointer; border-bottom: 1px solid #eee; }
        .chat-input { display: flex; padding: 10px; border-top: 1px solid var(--border); }
        .chat-input input { flex: 1; border: 1px solid #ddd; padding: 8px; border-radius: 5px; font-size: 12px; }
    </style>
</head>
<body>

<nav class="navbar">
    <a href="index.html" class="logo">HuggingHeart</a>
    <div class="nav-links">
        <a href="index.html">Home</a>
        <a href="community.html" style="color:var(--primary); font-weight:600;">Community</a>
    </div>
</nav>

<div class="main-wrapper">
    <aside class="sidebar">
        <div class="filter-card">
            <div class="filter-group">
                <label>Country</label>
                <select id="fCountry" onchange="applyFilters()"><option value="">All</option></select>
            </div>
            <div class="filter-group">
                <label>Profession</label>
                <select id="fJob" onchange="applyFilters()"><option value="">All</option></select>
            </div>
            <div class="filter-group">
                <label>Min Age</label>
                <input type="number" id="fAge" placeholder="20" oninput="applyFilters()">
            </div>
        </div>
    </aside>

    <div class="grid" id="girlGrid">
        <p id="loadingMsg">Searching profiles...</p>
    </div>
</div>

<div id="profileOverlay">
    <div class="profile-container" id="profileContent"></div>
</div>

<div id="chatBox">
    <div class="chat-header"><span id="chatTitle">Chat</span> <span onclick="closeChat()" style="cursor:pointer">✕</span></div>
    <div class="chat-msgs" id="chatMsgs"></div>
    <div class="sugg-box" id="suggBox"></div>
    <form class="chat-input" onsubmit="event.preventDefault(); sendUserMsg();">
        <input type="text" id="uInput" placeholder="Type a message..." oninput="handleTyping(this.value)">
    </form>
</div>

<script>
    let girlsDB = [];
    let activePersonality = [];
    let currentG = null;
    let userName = localStorage.getItem("HH_User") || "";

    async function init() {
        try {
            const res = await fetch('knowledge/Assertive_Girls_Profile_Database_V1.csv');
            if (!res.ok) throw new Error("Could not find CSV file");
            const text = await res.text();
            const rows = text.split('\n').slice(1);
            
            girlsDB = rows.map(r => {
                const c = r.split(',');
                if(c.length < 8) return null;
                return { id:c[0], name:c[1], age:c[2], country:c[4], job:c[5], type:c[6], bio:c[8] };
            }).filter(x => x);

            populateDropdowns();
            displayProfiles(girlsDB);
        } catch (err) {
            document.getElementById('loadingMsg').innerText = "Error: Please ensure the /knowledge/ folder is correct.";
            console.error(err);
        }
    }

    function displayProfiles(list) {
        const grid = document.getElementById('girlGrid');
        grid.innerHTML = list.length ? list.map(g => `
            <div class="card" onclick="openProfile('${g.id}')">
                <img src="knowledge/images/luna-avatar.png.png" onerror="this.src='https://via.placeholder.com/150'">
                <h3>${g.name}</h3>
                <p>${g.job} • ${g.country}</p>
            </div>
        `).join('') : "<p>No matches found.</p>";
    }

    function populateDropdowns() {
        const countries = [...new Set(girlsDB.map(g => g.country))];
        const jobs = [...new Set(girlsDB.map(g => g.job))];
        const cSel = document.getElementById('fCountry');
        const jSel = document.getElementById('fJob');
        countries.forEach(c => cSel.innerHTML += `<option value="${c}">${c}</option>`);
        jobs.forEach(j => jSel.innerHTML += `<option value="${j}">${j}</option>`);
    }

    function applyFilters() {
        const c = document.getElementById('fCountry').value;
        const j = document.getElementById('fJob').value;
        const a = document.getElementById('fAge').value;
        const filtered = girlsDB.filter(g => 
            (!c || g.country === c) && (!j || g.job === j) && (!a || parseInt(g.age) >= parseInt(a))
        );
        displayProfiles(filtered);
    }

    async function openProfile(id) {
        currentG = girlsDB.find(x => x.id == id);
        
        // Match personality filename
        const pType = currentG.type.trim().toLowerCase().replace(/\s+/g, '_');
        const pFile = `knowledge/type_${pType}.csv`;
        
        try {
            const pRes = await fetch(pFile);
            const pText = await pRes.text();
            activePersonality = pText.split('\n').slice(1).map(l => {
                const p = l.split(','); // Or '\t' if your files are tab-separated
                return { q: p[0]?.toLowerCase().trim(), a: p[1]?.trim() };
            });
        } catch(e) { 
            console.warn("Personality file missing, using Luna's default.");
            const lunaRes = await fetch('knowledge/luna_qa.csv');
            const lunaText = await lunaRes.text();
            activePersonality = lunaText.split('\n').slice(1).map(l => ({ q: l.split(',')[0]?.toLowerCase().trim(), a: l.split(',')[1] }));
        }

        document.getElementById('profileContent').innerHTML = `
            <div class="profile-left"><img src="knowledge/images/luna-avatar.png.png"></div>
            <div class="profile-right">
                <button onclick="document.getElementById('profileOverlay').style.display='none'">← Back</button>
                <h1 style="font-family:Playfair Display; margin-top:20px;">${currentG.name}</h1>
                <p><strong>${currentG.job}</strong> from ${currentG.country}</p>
                <p style="margin:20px 0; line-height:1.6; color:#555;">${currentG.bio}</p>
                <button class="btn-chat" onclick="startBot()">Message ${currentG.name.split(' ')[0]}</button>
            </div>
        `;
        document.getElementById('profileOverlay').style.display = 'block';
    }

    function startBot() {
        document.getElementById('chatBox').style.display = 'flex';
        document.getElementById('chatTitle').innerText = currentG.name;
        document.getElementById('chatMsgs').innerHTML = "";
        const hi = userName ? `Hi ${userName}! I'm ${currentG.name}.` : `Hi! I'm ${currentG.name}. What's your name?`;
        addChat(hi, 'bot');
    }

    function handleTyping(v) {
        const sBox = document.getElementById('suggBox');
        if(v.length >= 3) {
            const matches = activePersonality.filter(x => x.q && x.q.includes(v.toLowerCase())).slice(0, 3);
            if(matches.length > 0) {
                sBox.innerHTML = matches.map(m => `<div class="sugg-item" onclick="useSugg('${m.q}')">${m.q}</div>`).join('');
                sBox.style.display = 'block';
                return;
            }
        }
        sBox.style.display = 'none';
    }

    function useSugg(q) {
        document.getElementById('uInput').value = q;
        sendUserMsg();
    }

    function sendUserMsg() {
        const inp = document.getElementById('uInput');
        const text = inp.value.trim();
        if(!text) return;

        addChat(text, 'user');
        inp.value = "";
        document.getElementById('suggBox').style.display = 'none';

        setTimeout(() => {
            if(!userName) {
                userName = text;
                localStorage.setItem("HH_User", userName);
                addChat(`Nice to meet you, ${userName}! How can I help you today?`, 'bot');
            } else {
                const match = activePersonality.find(x => x.q && text.toLowerCase().includes(x.q));
                addChat(match ? match.a : "I'm not sure about that, but I'd love to hear more.", 'bot');
            }
        }, 700);
    }

    function addChat(t, s) {
        const div = document.createElement('div');
        div.className = `msg ${s}`;
        div.innerText = t;
        const box = document.getElementById('chatMsgs');
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
    }

    function closeChat() { document.getElementById('chatBox').style.display = 'none'; }

    init();
</script>
</body>
</html>
