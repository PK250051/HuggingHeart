// assets/js/chat-engine.js

let currentGirl = null;
let personalityQA = [];
let masterQuestions = [];
let userName = localStorage.getItem("HH_User") || "";

async function initChat() {
    const urlParams = new URLSearchParams(window.location.search);
    const girlId = urlParams.get('id');

    // 1. Load Girl Data
    const res = await fetch('knowledge/Assertive_Girls_Profile_Database_V1.csv');
    const text = await res.text();
    const rows = text.split('\n');
    const data = rows.find(r => r.startsWith(girlId)).split(',');

    currentGirl = { name: data[1], type: data[6], bio: data[8] };
    document.getElementById('pName').innerText = currentGirl.name;
    document.getElementById('pBio').innerText = currentGirl.bio;

    // 2. Load Personality CSV (Routing Logic)
    // Mapping e.g., "B1 Very Shy" -> "type_B1_very_shy.csv"
    const fileName = `knowledge/type_${currentGirl.type.toLowerCase().trim().replace(/\s+/g, '_')}.csv`;
    const pRes = await fetch(fileName);
    const pText = await pRes.text();
    personalityQA = pText.split('\n').slice(1).map(line => {
        const parts = line.split(',');
        return { q: parts[0]?.toLowerCase().trim(), a: parts[1] };
    });

    // 3. Load Master PQ for Suggestions
    const mRes = await fetch('knowledge/PQ_Master_List.csv');
    const mText = await mRes.text();
    masterQuestions = mText.split('\n').slice(1).map(l => l.split(',')[0]);

    startGreeting();
}

function startGreeting() {
    const msg = userName ? `Hi ${userName}! I'm ${currentGirl.name}. Ready to talk?` : `Hi! I'm ${currentGirl.name}. I'm a bit ${currentGirl.type.split(' ')[1].toLowerCase()}. What is your name?`;
    appendChat(msg, 'bot');
}

// SUGGESTION LOGIC (Triggers after 3 characters)
function showSuggestions(val) {
    const box = document.getElementById('suggBox');
    if (val.length >= 3) {
        const matches = masterQuestions.filter(q => q.toLowerCase().includes(val.toLowerCase())).slice(0, 3);
        if (matches.length > 0) {
            box.innerHTML = matches.map(m => `<div class="sugg-item" onclick="useSugg('${m}')">${m}</div>`).join('');
            box.style.display = 'block';
            return;
        }
    }
    box.style.display = 'none';
}

function useSugg(txt) {
    document.getElementById('userInput').value = txt;
    document.getElementById('suggBox').style.display = 'none';
    sendMessage();
}

function sendMessage() {
    const input = document.getElementById('userInput');
    const text = input.value.trim();
    if (!text) return;

    appendChat(text, 'user');
    input.value = "";
    document.getElementById('suggBox').style.display = 'none';

    setTimeout(() => {
        if (!userName) {
            userName = text;
            localStorage.setItem("HH_User", userName);
            appendChat(`Nice to meet you, ${userName}! Ask me anything you like.`, 'bot');
        } else {
            // Find answer in personality CSV
            const match = personalityQA.find(item => text.toLowerCase().includes(item.q));
            // Diplomatic Fallback
            const reply = match ? match.a : "I prefer to keep some mysteries for later. Tell me more about you?";
            appendChat(reply, 'bot');
        }
    }, 800);
}

function appendChat(txt, side) {
    const div = document.createElement('div');
    div.className = `msg ${side}`;
    div.innerText = txt;
    const body = document.getElementById('chatBody');
    body.appendChild(div);
    body.scrollTop = body.scrollHeight;
}

initChat();
