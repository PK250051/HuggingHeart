// assets/js/chat-engine.js
let userName = "";
let pqMaster = []; 
let lunaPersonality = [];

async function startChat() {
    // 1. Load Files
    const resQ = await fetch('data/questions/PQ_Master_List.csv');
    pqMaster = await resQ.text(); // Add a simple CSV parser later
    
    const resP = await fetch('data/answers/type_B1_very_shy.csv');
    lunaPersonality = await resP.text();

    // 2. Initial Greeting
    botReply("Hai! I am Luna. ðŸŒ¸ It is so nice to meet you. What is your name?");
}

async function botReply(fullText) {
    const status = document.getElementById('typing-status');
    const display = document.getElementById('chat-display');
    
    status.innerText = "Luna is typing...";
    await new Promise(r => setTimeout(r, 1000));
    status.innerText = "Online";

    const msgDiv = document.createElement('div');
    msgDiv.className = "bot-msg";
    display.appendChild(msgDiv);

    // Word by Word Effect
    const words = fullText.split(" ");
    for(let word of words) {
        msgDiv.innerText += word + " ";
        display.scrollTop = display.scrollHeight;
        await new Promise(r => setTimeout(r, 150));
    }
}

function handleTyping(val) {
    const box = document.getElementById('suggestion-box');
    if(val.length > 2) {
        // Simple filter logic for suggestions
        box.innerHTML = `<div class="sugg-item" onclick="selectSugg('How are you?')">How are you?</div>`;
        box.style.display = 'block';
    } else {
        box.style.display = 'none';
    }
}

function sendMsg() {
    const input = document.getElementById('user-input');
    const text = input.value.trim();
    if(!text) return;

    // Add user msg to UI
    const uDiv = document.createElement('div');
    uDiv.className = "user-msg";
    uDiv.innerText = text;
    document.getElementById('chat-display').appendChild(uDiv);
    input.value = "";

    if(!userName) {
        userName = text;
        botReply(`Nice to meet you, ${userName}! Ask me anything.`);
    } else {
        botReply("That is very interesting... tell me more?");
    }
}

window.onload = startChat;
